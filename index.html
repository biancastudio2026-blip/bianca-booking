<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Bianca_eye.studio é ç´„ç³»çµ±</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; background-color: #fdfbf7; overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    .slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .tab-content { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* èƒŒæ™¯åœ–æ¡ˆä½ç½® */
    .bg-doodle { position: absolute; pointer-events: none; opacity: 0.6; z-index: -1; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // --- Firebase è¨­å®š ---
    const firebaseConfig = {
      apiKey: "AIzaSyDPCo-OifrWYwQ5B94sdxTvqOSy0Fasjr8",
      authDomain: "biancatemp-2e89e.firebaseapp.com",
      projectId: "biancatemp-2e89e",
      storageBucket: "biancatemp-2e89e.firebasestorage.app",
      messagingSenderId: "272754208042",
      appId: "1:272754208042:web:7ef2864c3bd7dacab8c253",
      measurementId: "G-6CTBV02QR4"
    };

    // åˆå§‹åŒ– Firebase (å–®æ©Ÿç‰ˆå¯«æ³•)
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    const SCHEDULE_COLLECTION = 'bianca_schedule_data';
    const CLIENTS_COLLECTION = 'bianca_clients_data';

    // --- åœ–ç¤ºåº« (å…¨éƒ¨å…§å»º SVG) ---
    const Icons = {
      Menu: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
      X: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
      Instagram: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/></svg>,
      MessageCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>,
      ChevronDown: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
      ChevronUp: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>,
      Star: ({fill, ...p}) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={fill || "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
      Heart: ({fill, ...p}) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={fill || "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
      Sparkles: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M3 7.5v-1"/></svg>,
      Calendar: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
      MapPin: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
      Clock: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      Trash2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
      Plus: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
      Lock: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
      User: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
      Ban: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>,
      Search: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
      Send: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
      UserPlus: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" x2="20" y1="8" y2="14"/><line x1="23" x2="17" y1="11" y2="11"/></svg>,
      Settings: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
      // æ‰‹ç¹ªé¢¨é£›æ©Ÿ
      PlaneDoodle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`w-8 h-8 -rotate-45 ${p.className || ''}`}><path d="M22 2 11 13"/><path d="m22 2-7 20-4-9-9-4 20-7Z"/></svg>,
      // æ‰‹ç¹ªé¢¨ç­†
      PenDoodle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`w-8 h-8 ${p.className || ''}`}><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
      // Check (æ‰“å‹¾)
      Check: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
      Crown: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>
    };

    const DoodleEye = ({ className }) => (<svg viewBox="0 0 100 60" className={className} fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round"><path d="M10,40 Q50,10 90,40" /><path d="M20,28 L15,15" /><path d="M35,22 L32,8" /><path d="M50,20 L50,5" /><path d="M65,22 L68,8" /><path d="M80,28 L85,15" /></svg>);
    const SquiggleLine = ({ className }) => (<svg viewBox="0 0 100 20" className={className} fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round"><path d="M5,10 Q25,20 50,10 T95,10" /></svg>);
    const HandDrawnBorder = ({ children, className = "" }) => (<div className={`border-2 border-stone-400 bg-white p-6 shadow-sm relative z-10 ${className}`} style={{ borderRadius: "255px 15px 225px 15px / 15px 225px 15px 255px" }}>{children}</div>);

    // [ä¿®æ”¹] èƒŒæ™¯å¡—é´‰å…ƒä»¶ (ç°ç²‰è‰²ç·šæ¢)
    const BackgroundDoodles = () => (
      <div className="fixed inset-0 z-0 overflow-hidden pointer-events-none select-none">
         <div className="absolute top-10 left-5 opacity-40"><Icons.Sparkles className="w-16 h-16 text-[#e6d5d8]"/></div>
         <div className="absolute top-20 right-[-20px] opacity-30 rotate-12"><Icons.Heart className="w-24 h-24 text-[#e6d5d8]" fill="#e6d5d8"/></div>
         <div className="absolute bottom-40 left-[-30px] opacity-20 -rotate-12"><Icons.Star className="w-32 h-32 text-[#e6d5d8]" fill="#e6d5d8"/></div>
         <div className="absolute bottom-10 right-10 opacity-30"><SquiggleLine className="w-24 h-6 text-[#e6d5d8]"/></div>
         <div className="absolute top-1/3 left-1/4 opacity-20 rotate-45"><Icons.PlaneDoodle className="w-20 h-20 text-[#e6d5d8]"/></div>
         <div className="absolute bottom-1/3 right-1/4 opacity-20 -rotate-12"><Icons.PenDoodle className="w-16 h-16 text-[#e6d5d8]"/></div>
         <div className="absolute top-1/2 left-10 opacity-20 text-[#e6d5d8] text-6xl font-bold">~</div>
         <div className="absolute top-24 right-1/3 opacity-20"><Icons.Sparkles className="w-10 h-10 text-[#e6d5d8]"/></div>
      </div>
    );

    // ç«æ¯›æ•´ç†æ•™å­¸åœ–
    const EyelashTutorialDoodle = ({ mode }) => {
      return (
        <div className="flex flex-col items-center justify-center p-4 bg-[#fdfbf7] rounded-xl border-2 border-dashed border-[#dcb5bc]">
           <svg viewBox="0 0 100 60" className="w-24 h-16 text-stone-600 mb-2" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M10,30 Q50,5 90,30" />
              <path d="M10,30 Q50,55 90,30" />
              <circle cx="50" cy="30" r="8" />
              <path d="M20,22 L15,10" /><path d="M35,16 L32,5" /><path d="M50,14 L50,2" /><path d="M65,16 L68,5" /><path d="M80,22 L85,10" />
              {mode === 'bundle' ? (
                 <>
                   <line x1="50" y1="20" x2="50" y2="55" stroke="#b07d88" strokeWidth="3" />
                   <rect x="47" y="20" width="6" height="15" fill="#b07d88" stroke="none" rx="2" />
                   <path d="M40,45 L35,45 M60,45 L65,45" stroke="#b07d88" markerEnd="url(#arrow)" />
                   <path d="M75,25 L90,40 M78,22 L93,37" stroke="#b07d88" />
                 </>
              ) : (
                 <>
                   <line x1="20" y1="10" x2="80" y2="10" stroke="#b07d88" strokeWidth="3" />
                   <rect x="25" y="7" width="50" height="6" fill="#b07d88" stroke="none" rx="2" />
                   <path d="M30,20 L30,15 M50,20 L50,15 M70,20 L70,15" stroke="#b07d88" />
                 </>
              )}
           </svg>
           <span className="text-xs font-bold text-[#b07d88]">
              {mode === 'bundle' ? 'ç›´æ‹¿å·¦å³åˆ· / é‘·å­å¤¾æŸ' : 'æ©«æ‹¿å‘ä¸Šæ¢³é †'}
           </span>
        </div>
      );
    };

    const ReservationLookupModal = ({ isOpen, onClose }) => {
      const [searchKey, setSearchKey] = useState('');
      const [results, setResults] = useState([]);
      const [hasSearched, setHasSearched] = useState(false);
      const [loading, setLoading] = useState(false);

      const handleSearch = async () => {
        if (!searchKey) return;
        setLoading(true);
        setResults([]);
        try {
          const querySnapshot = await db.collection(SCHEDULE_COLLECTION).get();
          const found = [];
          const now = new Date();
          const todayStr = now.toISOString().split('T')[0];

          querySnapshot.forEach(doc => {
            const date = doc.id;
            if (date < todayStr) return; 
            const data = doc.data();
            if (data.slots) {
              data.slots.forEach(slot => {
                if (slot.status === 'booked' && (slot.clientPhone === searchKey || slot.clientName === searchKey)) {
                  found.push({ date, ...slot });
                }
              });
            }
          });
          found.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
          setResults(found);
          setHasSearched(true);
        } catch (e) {
          alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
          console.error(e);
        }
        setLoading(false);
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 modal-overlay" onClick={onClose}>
           <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-xl border-2 border-stone-200 slide-up" onClick={e => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4 border-b border-stone-100 pb-2">
                <h3 className="font-bold text-stone-700 text-lg flex items-center gap-2"><Icons.Search size={20} /> é ç´„æŸ¥è©¢</h3>
                <button onClick={onClose}><Icons.X className="text-stone-400" /></button>
              </div>
              <div className="space-y-4">
                 <div className="flex gap-2">
                   <input
                     type="text"
                     placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æˆ–å§“å"
                     value={searchKey}
                     onChange={e => setSearchKey(e.target.value)}
                     className="flex-1 border border-stone-200 rounded-lg p-2 text-sm outline-none focus:border-[#dcb5bc]"
                   />
                   <button onClick={handleSearch} disabled={loading} className="bg-[#dcb5bc] text-white px-4 rounded-lg font-bold">
                     {loading ? '...' : 'æŸ¥è©¢'}
                   </button>
                 </div>

                 <div className="max-h-[50vh] overflow-y-auto no-scrollbar space-y-3">
                    {hasSearched && results.length === 0 && <p className="text-center text-stone-400 text-sm">æŸ¥ç„¡é ç´„è³‡æ–™</p>}
                    {results.map((res, idx) => (
                      <div key={idx} className="bg-stone-50 border border-stone-200 rounded-xl p-3 relative overflow-hidden">
                         <div className="absolute top-0 left-0 w-1 h-full bg-[#dcb5bc]"></div>
                         <div className="pl-3">
                           <div className="flex justify-between items-baseline mb-1">
                             <span className="font-bold text-lg text-stone-700">{res.date}</span>
                             <span className="font-bold text-[#b07d88] text-lg">{res.time}</span>
                           </div>
                           <div className="text-sm text-stone-600 mb-1 flex items-center gap-1"><Icons.MapPin size={12}/> {res.location}</div>
                           <div className="text-xs text-stone-500 bg-white p-2 rounded-lg border border-stone-100">
                             {res.services || "é ç´„é …ç›® (èˆŠè³‡æ–™æœªé¡¯ç¤ºè©³ç´°é …ç›®)"}
                           </div>
                         </div>
                      </div>
                    ))}
                 </div>

                 <div className="bg-[#fff5f5] border border-red-100 p-3 rounded-xl flex items-start gap-3">
                    <div className="bg-red-400 rounded-full p-1 text-white shrink-0 mt-0.5">
                      <Icons.MessageCircle size={14} />
                    </div>
                    <div className="text-xs text-stone-600 leading-relaxed">
                       <span className="font-bold text-red-400 block mb-0.5">éœ€ä¿®æ”¹é ç´„ï¼Ÿ</span>
                       è‹¥éœ€è¦æ›´æ”¹é ç´„å…§å®¹æˆ–æ™‚é–“ï¼Œè«‹ç›´æ¥é€é LINE è¨Šæ¯<span className="font-bold text-stone-700">è“è“</span>åšä¿®æ”¹ï¼
                    </div>
                 </div>
                 <a href="https://lin.ee/49zZehk" target="_blank" className="block w-full text-center bg-[#06c755] text-white py-2 rounded-xl text-sm font-bold shadow-sm hover:opacity-90">
                   å‰å¾€ LINE å®˜æ–¹å¸³è™Ÿ
                 </a>
              </div>
           </div>
        </div>
      );
    }

    const BlacklistManagerModal = ({ isOpen, onClose, initialTab }) => {
      const [tab, setTab] = useState('list'); 
      const [blacklistClients, setBlacklistClients] = useState([]);
      const [loading, setLoading] = useState(false);
      
      const [newPhone, setNewPhone] = useState('');
      const [newName, setNewName] = useState('');
      const [newNote, setNewNote] = useState('');

      useEffect(() => {
        if (isOpen) {
          setTab(initialTab || 'list');
          fetchBlacklist();
        }
      }, [isOpen, initialTab]);

      const fetchBlacklist = async () => {
        setLoading(true);
        try {
          const snapshot = await db.collection(CLIENTS_COLLECTION).where("blacklist", "==", true).get();
          const list = [];
          snapshot.forEach((doc) => {
            list.push(doc.data());
          });
          setBlacklistClients(list);
        } catch (error) {
          console.error("Error fetching blacklist:", error);
          alert("è®€å–é»‘åå–®å¤±æ•—");
        }
        setLoading(false);
      };

      const handleRemoveBlacklist = async (phone) => {
        if (!confirm(`ç¢ºå®šè¦å°‡ ${phone} ç§»å‡ºé»‘åå–®å—ï¼Ÿ`)) return;
        try {
          await db.collection(CLIENTS_COLLECTION).doc(phone).update({ blacklist: false });
          setBlacklistClients(prev => prev.filter(c => c.phone !== phone));
          alert("å·²ç§»é™¤");
        } catch (e) {
          alert("ç§»é™¤å¤±æ•—: " + e.message);
        }
      };

      const handleAddBlacklist = async () => {
        if (!newPhone || newPhone.length !== 10) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„10ç¢¼é›»è©±è™Ÿç¢¼");
        if (!newName) return alert("è«‹è¼¸å…¥å§“å");

        try {
          await db.collection(CLIENTS_COLLECTION).doc(newPhone).set({
            phone: newPhone,
            name: newName,
            notes: newNote,
            blacklist: true,
            visitCount: 0 
          }, { merge: true }); 

          alert("å·²åŠ å…¥é»‘åå–®");
          setNewPhone(''); setNewName(''); setNewNote('');
          fetchBlacklist(); 
          setTab('list'); 
        } catch (e) {
          alert("åŠ å…¥å¤±æ•—: " + e.message);
        }
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 modal-overlay" onClick={onClose}>
          <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-xl border-2 border-stone-200 slide-up flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4 border-b border-stone-100 pb-2">
              <h3 className="font-bold text-stone-700 text-lg flex items-center gap-2">
                <Icons.Ban className="text-red-500" /> é»‘åå–®ç®¡ç†
              </h3>
              <button onClick={onClose}><Icons.X className="text-stone-400" /></button>
            </div>

            <div className="flex gap-2 mb-4">
              <button onClick={() => setTab('list')} className={`flex-1 py-1 text-xs font-bold rounded-lg ${tab==='list'?'bg-stone-600 text-white':'bg-stone-100 text-stone-500'}`}>åå–®åˆ—è¡¨</button>
              <button onClick={() => setTab('add')} className={`flex-1 py-1 text-xs font-bold rounded-lg ${tab==='add'?'bg-red-500 text-white':'bg-stone-100 text-stone-500'}`}>æ–°å¢é»‘åå–®</button>
            </div>

            <div className="flex-1 overflow-y-auto no-scrollbar">
              {tab === 'list' ? (
                <div className="space-y-2">
                  {loading ? <p className="text-center text-xs text-stone-400">è¼‰å…¥ä¸­...</p> : blacklistClients.length === 0 ? <p className="text-center text-xs text-stone-400 py-4">ç›®å‰æ²’æœ‰é»‘åå–®</p> : 
                    blacklistClients.map(client => (
                      <div key={client.phone} className="bg-stone-50 p-3 rounded-lg border border-stone-200 flex justify-between items-center">
                        <div>
                          <div className="font-bold text-sm text-stone-700">{client.name}</div>
                          <div className="text-xs text-stone-500">{client.phone}</div>
                          {client.notes && <div className="text-[10px] text-red-400 mt-1">{client.notes}</div>}
                        </div>
                        <button onClick={() => handleRemoveBlacklist(client.phone)} className="text-stone-400 hover:text-red-500"><Icons.Trash2 size={16} /></button>
                      </div>
                    ))
                  }
                </div>
              ) : (
                <div className="space-y-3">
                  <div className="bg-red-50 p-3 rounded-lg text-xs text-red-500 mb-2">
                    åœ¨æ­¤æ–°å¢çš„é›»è©±å°‡æœƒç›´æ¥è¢«ç¦æ­¢é ç´„ã€‚
                  </div>
                  <input type="tel" placeholder="é›»è©±è™Ÿç¢¼ (09xxxxxxxx)" value={newPhone} onChange={e=>setNewPhone(e.target.value)} className="w-full border border-stone-200 rounded-lg p-2 text-sm outline-none" />
                  <input type="text" placeholder="å§“å" value={newName} onChange={e=>setNewName(e.target.value)} className="w-full border border-stone-200 rounded-lg p-2 text-sm outline-none" />
                  <textarea placeholder="å‚™è¨» (åŸå› )" value={newNote} onChange={e=>setNewNote(e.target.value)} className="w-full border border-stone-200 rounded-lg p-2 text-sm outline-none h-20" />
                  <button onClick={handleAddBlacklist} className="w-full bg-red-500 text-white py-2 rounded-lg font-bold shadow-md hover:bg-red-600">åŠ å…¥é»‘åå–®</button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const BookingModal = ({ isOpen, onClose, slot, dateKey }) => {
      const [step, setStep] = useState(1);
      const [clientPhone, setClientPhone] = useState('');
      const [clientData, setClientData] = useState(null); 
      const [loading, setLoading] = useState(false);
      const [clientName, setClientName] = useState('');
      
      const [services, setServices] = useState({
        upper: false, upperTint: false,
        lower: false, lowerTint: false, brow: false
      });

      useEffect(() => {
        if(isOpen) {
          setStep(1); setClientPhone(''); setClientData(null);
          setClientName(''); 
          setServices({ upper: false, upperTint: false, lower: false, lowerTint: false, brow: false });
        }
      }, [isOpen]);

      if (!isOpen) return null;

      const checkClient = async () => {
        if(clientPhone.length !== 10) return alert("è«‹ç¢ºèªé›»è©±è™Ÿç¢¼æ˜¯å¦æœ‰èª¤~");
        setLoading(true);
        try {
          const docRef = db.collection(CLIENTS_COLLECTION).doc(clientPhone);
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            const data = docSnap.data();
            if (data.blacklist) {
              alert("æ‚¨æœ‰é ç´„æœªåˆ°çš„ç´€éŒ„, è«‹ç›´æ¥åˆ©ç”¨å®˜æ–¹Lineèˆ‡åº—å®¶è¯ç¹«~");
              window.location.href = "https://lin.ee/49zZehk";
              onClose();
              return;
            }
            setClientData({ ...data, status: 'old' });
            setClientName(data.name || '');
          } else {
            setClientData({ status: 'new' });
          }
          setStep(2);
        } catch (e) { console.error(e); alert("ç³»çµ±éŒ¯èª¤"); }
        setLoading(false);
      };

      const isNewClient = clientData?.status === 'new';
      const PRICES = { upper: isNewClient ? 699 : 999, brow: isNewClient ? 699 : 999, lower_single: 500, lower_combo: 300, tint_upper: 200, tint_lower: 100 };
      const MEMBER_PRICES = { upper: 850, lower_single: 400, lower_combo: 250, brow: 850, combo_discount: 100 };

      let total = 0;
      if (services.upper) total += PRICES.upper;
      if (services.lower) total += (services.upper ? PRICES.lower_combo : PRICES.lower_single);
      if (services.brow) total += PRICES.brow;
      
      let comboDiscount = 0;
      if ((services.upper || services.lower) && services.brow) { comboDiscount = 100; total -= comboDiscount; }

      if (services.upperTint && services.upper) total += PRICES.tint_upper;
      if (services.lowerTint && services.lower) total += PRICES.tint_lower;
      
      let tintDiscount = 0;
      if (services.upperTint && services.lowerTint && services.upper && services.lower) { tintDiscount = 50; total -= tintDiscount; }

      let memberTotal = 0;
      if (services.upper) memberTotal += MEMBER_PRICES.upper;
      if (services.brow) memberTotal += MEMBER_PRICES.brow;
      if ((services.upper || services.lower) && services.brow) memberTotal -= MEMBER_PRICES.combo_discount;
      if (services.lower) { memberTotal += (services.upper ? MEMBER_PRICES.lower_combo : MEMBER_PRICES.lower_single); }
      if (services.upperTint && services.upper) memberTotal += PRICES.tint_upper;
      if (services.lowerTint && services.lower) memberTotal += PRICES.tint_lower;
      if (services.upperTint && services.lowerTint && services.upper && services.lower) memberTotal -= 50;
      if (services.upper && services.lower) memberTotal -= 200;

      const handleConfirm = async () => {
        if (!clientName) return alert("è«‹å¡«å¯«å§“åä»¥ä¾¿è¯ç¹«");

        const items = [];
        if (services.upper) items.push(`ä¸Šç«æ¯›ç®¡ç† ($${PRICES.upper})`);
        if (services.upperTint) items.push(`  + æ¿ƒé»‘é¤Šè­· ($${PRICES.tint_upper})`);
        if (services.lower) items.push(`ä¸‹ç«æ¯›ç®¡ç† ($${services.upper ? PRICES.lower_combo : PRICES.lower_single})`);
        if (services.lowerTint) items.push(`  + æ¿ƒé»‘é¤Šè­· ($${PRICES.tint_lower})`);
        if (services.brow) items.push(`é‡ç”Ÿçœ‰é›•å¡‘ ($${PRICES.brow})`);
        
        if ((services.upper || services.lower) && services.brow) items.push(`(çœ‰ç«åˆè³¼æŠ˜æŠµ -$100)`);
        if (services.upper && services.lower) items.push(`(ä¸Šä¸‹ç«æ¯›åˆè³¼æŠ˜æŠµ -$200)`);
        if (tintDiscount > 0) items.push(`(æ¿ƒé»‘é¤Šè­·åˆè³¼å„ªæƒ  -$50)`);

        if (!isNewClient) items.push(`(æ­¡è¿å›å¨˜å®¶â™¡)`);

        let extraInfo = '';
        if (slot.location.includes('æ–°ç«¹')) extraInfo = '\nåœ°å€ï¼š(è«‹å¡«å¯«è©³ç´°åœ°å€ï¼Œåˆ°åºœè²»$100-150è¦–è·é›¢å ±åƒ¹)';

        const text = `Hi Bianca, æˆ‘æƒ³é ç´„ï¼š\næ—¥æœŸï¼š${dateKey}\næ™‚é–“ï¼š${slot.time}\nåœ°é»ï¼š${slot.location}${extraInfo}\n\né ç´„é …ç›®ï¼š\n${items.join('\n')}\n\né ä¼°é‡‘é¡ï¼š$${total}\n\nå§“åï¼š${clientName}\né›»è©±ï¼š${clientPhone}\n\n*å‚™è¨»ï¼šç•¶å¤©è‹¥å¸¶å¦ï¼Œéœ€åŠ æ”¶$100å¸å¦è²»*`;

        let copySuccess = false;
        try {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            copySuccess = document.execCommand('copy');
            document.body.removeChild(textArea);
        } catch (e) {
            console.error("Copy failed", e);
        }

        try {
          await db.runTransaction(async (transaction) => {
            const scheduleRef = db.collection(SCHEDULE_COLLECTION).doc(dateKey);
            const scheduleDoc = await transaction.get(scheduleRef);
            
            if (!scheduleDoc.exists) throw new Error("è¡Œç¨‹è¡¨è³‡æ–™ä¸å­˜åœ¨");

            const slots = scheduleDoc.data().slots || [];
            
            const duplicateBooking = slots.find(s => 
              s.status === 'booked' && 
              s.clientName === clientName && 
              s.clientPhone === clientPhone
            );

            if (duplicateBooking) {
                throw new Error("DUPLICATE_BOOKING");
            }

            const targetSlotIndex = slots.findIndex(s => s.id === slot.id);
            if (targetSlotIndex === -1) throw new Error("æ‰¾ä¸åˆ°è©²æ™‚æ®µ");
            if (slots[targetSlotIndex].status !== 'open') throw new Error("æŠ±æ­‰ï¼è©²æ™‚æ®µå‰›å‰›è¢«å…¶ä»–äººæ¶å…ˆé ç´„äº† ğŸ˜­");

            slots[targetSlotIndex].status = 'booked';
            slots[targetSlotIndex].clientName = clientName;
            slots[targetSlotIndex].clientPhone = clientPhone;
            slots[targetSlotIndex].services = items.join(', ');

            transaction.update(scheduleRef, { slots: slots });

            const clientRef = db.collection(CLIENTS_COLLECTION).doc(clientPhone);
            transaction.set(clientRef, {
              phone: clientPhone,
              name: clientName,
              lastVisit: dateKey,
              visitCount: (clientData?.visitCount || 0) + 1,
              blacklist: false
            }, { merge: true });
          });

          if (copySuccess) {
              alert("å·²è‡ªå‹•è¤‡è£½é ç´„æ ¼å¼ï¼\nè«‹è·³è½‰è‡³ LINE å¾Œã€Œè²¼ä¸Šã€ä¸¦å¡«å¯«å‚³é€ã€‚\n\nâš ï¸ é—†å¨˜å°æé†’ï¼š\næœƒç›¡å¯èƒ½å®‰æ’æ™‚é–“ï¼Œä½†å¦‚æœçœŸçš„å–¬ä¸åˆ°å¯ä»¥é…åˆçš„æ™‚é–“ï¼Œå¾ˆæŠ±æ­‰...ä¹Ÿè¬è¬å¦³é¡˜æ„çµ¦æˆ‘æ©Ÿæœƒï¼Œå¸Œæœ›æœªä¾†é‚„æ˜¯èƒ½å¤ æœå‹™åˆ°å¦³â¤ï¸");
          } else {
              alert("é ç´„æˆåŠŸï¼æ™‚æ®µå·²ç‚ºæ‚¨ä¿ç•™ã€‚\n(è‡ªå‹•è¤‡è£½å¤±æ•—) è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹å‚³é€çµ¦ LINE å®¢æœï¼š\n\n" + text);
          }

          window.location.href = "https://lin.ee/49zZehk";
          setTimeout(() => { onClose(); }, 500);

        } catch (e) {
          if (e.message === "DUPLICATE_BOOKING") {
              alert("æ‚¨å·²é ç´„ä¸åŒæ™‚æ®µ, è«‹ç›´æ¥ä½¿ç”¨Lineå‘Biancaå®˜æ–¹è¯ç¹«");
              onClose();
              return;
          }
          alert("é ç´„å¤±æ•—ï¼š" + e.message);
          if (e.message.includes("æ¶å…ˆ")) { onClose(); }
        }
      };

      return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 modal-overlay" onClick={onClose}>
          <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-xl border-2 border-stone-200 slide-up" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-stone-700 text-lg">
                {step === 1 ? 'æœƒå“¡é©—è­‰' : (isNewClient ? 'âœ¨ æ–°å®¢é«”é©—é ç´„' : 'â¤ï¸ VIP å›è¨ªé ç´„')}
              </h3>
              <button onClick={onClose}><Icons.X className="text-stone-400" /></button>
            </div>
            
            {step === 1 ? (
              <div className="space-y-4">
                <p className="text-sm text-stone-500">è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œç³»çµ±å°‡è‡ªå‹•æŸ¥è©¢æ˜¯å¦äº«æœ‰æ–°å®¢é«”é©—åƒ¹ã€‚</p>
                <input 
                  type="tel" 
                  value={clientPhone}
                  onChange={e => setClientPhone(e.target.value)}
                  placeholder="09xxxxxxxx"
                  className="w-full border-2 border-stone-200 rounded-xl p-3 text-lg outline-none focus:border-[#dcb5bc]"
                />
                <button 
                  onClick={checkClient} 
                  disabled={loading}
                  className="w-full bg-[#dcb5bc] text-white py-3 rounded-xl font-bold shadow-md hover:opacity-90 transition disabled:opacity-50"
                >
                  {loading ? 'æŸ¥è©¢ä¸­...' : 'ä¸‹ä¸€æ­¥'}
                </button>
              </div>
            ) : (
              <div className="space-y-3 mb-6 max-h-[60vh] overflow-y-auto no-scrollbar">
                
                <div className="mb-2">
                  <input type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" value={clientName} onChange={e=>setClientName(e.target.value)} className="w-full border-2 border-stone-200 rounded-lg p-2 text-sm outline-none focus:border-[#dcb5bc]" />
                </div>

                <div className="border border-stone-200 rounded-xl p-3">
                  <label className="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" checked={services.upper} onChange={() => setServices(p => ({...p, upper: !p.upper, upperTint: !p.upper ? false : p.upperTint}))} className="w-5 h-5 accent-[#dcb5bc]" />
                    <span className="font-bold text-stone-600">ä¸Šç«æ¯›ç®¡ç† <span className="text-[#b07d88]">${PRICES.upper}</span></span>
                  </label>
                  {services.upper && (
                    <div className="ml-8 mt-2 pt-2 border-t border-dashed border-stone-100">
                      <label className="flex items-center gap-2 cursor-pointer text-sm text-stone-500">
                        <input type="checkbox" checked={services.upperTint} onChange={() => setServices(p => ({...p, upperTint: !p.upperTint}))} className="accent-[#dcb5bc]" />
                        + åŠ è³¼æ¿ƒé»‘é¤Šè­· ($200)
                      </label>
                    </div>
                  )}
                </div>

                <div className="border border-stone-200 rounded-xl p-3">
                  <label className="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" checked={services.lower} onChange={() => setServices(p => ({...p, lower: !p.lower, lowerTint: !p.lower ? false : p.lowerTint}))} className="w-5 h-5 accent-[#dcb5bc]" />
                    <div className="flex flex-col">
                      <span className="font-bold text-stone-600">ä¸‹ç«æ¯›ç®¡ç†</span>
                      <span className="text-xs text-stone-400">å–®ä½œ$500 / æ­é…ä¸Šç«æ¯›å„ªæƒ  <span className="text-[#b07d88] font-bold">$300</span></span>
                    </div>
                  </label>
                  {services.lower && (
                    <div className="ml-8 mt-2 pt-2 border-t border-dashed border-stone-100">
                      <label className="flex items-center gap-2 cursor-pointer text-sm text-stone-500">
                        <input type="checkbox" checked={services.lowerTint} onChange={() => setServices(p => ({...p, lowerTint: !p.lowerTint}))} className="accent-[#dcb5bc]" />
                        + åŠ è³¼æ¿ƒé»‘é¤Šè­· ($100)
                      </label>
                    </div>
                  )}
                </div>

                <div className="border border-stone-200 rounded-xl p-3">
                  <label className="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" checked={services.brow} onChange={() => setServices(p => ({...p, brow: !p.brow}))} className="w-5 h-5 accent-[#dcb5bc]" />
                    <div className="flex flex-col">
                      <span className="font-bold text-stone-600">é‡ç”Ÿçœ‰é›•å¡‘ <span className="text-[#b07d88]">${PRICES.brow}</span></span>
                      {(services.upper || services.lower) && <span className="text-xs text-[#b07d88] font-bold">âœ¨ èˆ‡ä»»ä¸€ç«æ¯›ç®¡ç†åˆè³¼å†æŠ˜ $100</span>}
                    </div>
                  </label>
                </div>

                <div className="text-xs text-red-400 bg-red-50 p-2 rounded-lg text-center">
                  âš ï¸ æé†’ï¼šç•¶å¤©è‹¥å¸¶å¦åˆ°ï¼Œéœ€åŠ æ”¶ $100 å¸å¦è²»
                </div>
                
                {/* [ä¿®æ”¹] æ¢å¾©é»ƒè‰²ä¾¿åˆ©è²¼æé†’å€å¡Š */}
                <div className="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-3 text-xs rounded shadow-sm relative">
                   <div className="font-bold mb-1 flex items-center gap-1"><Icons.Sparkles className="w-3 h-3"/> é ç´„å°æé†’</div>
                   <p>é ç´„æ™‚é–“é¸æ“‡å¾Œï¼Œå°‡è‡ªå‹•è¤‡è£½é ç´„è³‡è¨Šï¼Œè«‹è·³è½‰è‡³LINEå¾Œï¼Œ<span className="font-bold underline text-red-500 bg-yellow-200 px-1 rounded">[è²¼ä¸Š]</span>é ç´„è³‡è¨Šä¸¦ç¢ºèªå¾Œï¼Œç™¼é€çµ¦é—†å¨˜åšæ ¸å°ç¢ºèªå“¦!</p>
                </div>

                <div className="bg-[#fae8eb] p-4 rounded-xl flex flex-col gap-1">
                  <div className="flex justify-between items-center">
                    <span className="text-stone-600 font-bold text-sm">é ä¼°é‡‘é¡</span>
                    <span className="text-[#b07d88] font-bold text-xl">${total}</span>
                  </div>
                  
                  {clientData?.isStoreMember && (
                    <div className="text-right border-t border-dashed border-[#dcb5bc]/30 pt-1 mt-1">
                      <span className="text-xs text-stone-500 mr-2">(å„²å€¼æœƒå“¡é ä¼°æ‰£æ¬¾)</span>
                      <span className="text-sm font-bold text-[#b07d88]">${memberTotal}</span>
                    </div>
                  )}

                  {comboDiscount > 0 && <span className="text-xs text-[#b07d88] text-right">å·²æ‰£é™¤ç«æ¯›ç®¡ç†èˆ‡é‡ç”Ÿçœ‰åˆè³¼å„ªæƒ  -$100</span>}
                  {(services.upper && services.lower) && <span className="text-xs text-[#b07d88] text-right">å·²æ‰£é™¤ä¸Š/ ä¸‹ç«æ¯›ç®¡ç†åˆè³¼å„ªæƒ  -$200</span>}
                  {tintDiscount > 0 && <span className="text-xs text-[#b07d88] text-right">å·²æ‰£é™¤æ¿ƒé»‘é¤Šè­·åˆè³¼å„ªæƒ  -$50</span>}
                </div>

                <button onClick={handleConfirm} disabled={total === 0} className="w-full bg-[#dcb5bc] text-white py-3 rounded-xl font-bold shadow-md hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
                  ç¢ºèªé ç´„ï¼Œå‰å¾€ LINE
                </button>
              </div>
            )}
          </div>
        </div>
      );
    };

    const AdminPanel = ({ selectedDateKey, newTime, setNewTime, newLocation, setNewLocation, addSlot }) => {
      const [view, setView] = useState('booking'); 
      const [phoneSearch, setPhoneSearch] = useState('');
      const [searchResult, setSearchResult] = useState(null);
      const [showBlacklistManager, setShowBlacklistManager] = useState(false);
      const [blacklistManagerTab, setBlacklistManagerTab] = useState('list');

      const searchClient = async () => {
        if(!phoneSearch) return;
        try {
          const docRef = db.collection(CLIENTS_COLLECTION).doc(phoneSearch);
          const docSnap = await docRef.get();
          if (docSnap.exists) setSearchResult(docSnap.data());
          else setSearchResult('not_found');
        } catch(e) { alert(e.message); }
      };
      
      const toggleStoreMember = async () => {
        if(!searchResult || searchResult === 'not_found') return;
        try {
          const newValue = !searchResult.isStoreMember;
          await db.collection(CLIENTS_COLLECTION).doc(searchResult.phone).update({
            isStoreMember: newValue
          });
          setSearchResult(prev => ({...prev, isStoreMember: newValue}));
          alert(newValue ? "å·²è¨­å®šç‚ºå„²å€¼æœƒå“¡" : "å·²å–æ¶ˆå„²å€¼æœƒå“¡è³‡æ ¼");
        } catch(e) { alert(e.message); }
      };

      const toggleBlacklist = async () => {
        if(!searchResult || searchResult === 'not_found') return;
        try {
          await db.collection(CLIENTS_COLLECTION).doc(searchResult.phone).update({
            blacklist: !searchResult.blacklist
          });
          setSearchResult(prev => ({...prev, blacklist: !prev.blacklist}));
        } catch(e) { alert(e.message); }
      };

      const saveNote = async (note) => {
        try {
          await db.collection(CLIENTS_COLLECTION).doc(searchResult.phone).update({ notes: note });
          alert("å‚™è¨»å·²å„²å­˜");
        } catch(e) { alert(e.message); }
      };

      const openBlacklistAdd = () => {
        setBlacklistManagerTab('add');
        setShowBlacklistManager(true);
      };

      const openBlacklistSettings = () => {
        setBlacklistManagerTab('list');
        setShowBlacklistManager(true);
      };

      const setTamsuiSchedule = async () => {
        if (!confirm(`ç¢ºå®šè¦è¨­å®š ${selectedDateKey} ç‚ºæ·¡æ°´ç­è¡¨å—ï¼Ÿ(å°‡è¦†è“‹ç•¶æ—¥èˆŠè¨­å®š)`)) return;
        const slots = ['09:30', '13:00', '15:30', '19:00'].map(time => ({
          id: Date.now().toString() + time.replace(':', ''),
          time,
          location: 'æ·¡æ°´è‡ªå®…',
          status: 'open'
        }));
        try {
          await db.collection(SCHEDULE_COLLECTION).doc(selectedDateKey).set({ slots: slots });
          alert("æ·¡æ°´ç­è¡¨å·²è¨­å®šå®Œæˆ");
        } catch (e) { alert(e.message); }
      };

      const setZhubeiSchedule = async () => {
        if (!confirm(`ç¢ºå®šè¦è¨­å®š ${selectedDateKey} ç‚ºç«¹åŒ—(éœ€å”èª¿)å—ï¼Ÿ(å°‡è¦†è“‹ç•¶æ—¥èˆŠè¨­å®š)`)) return;
        const slots = [{
          id: Date.now().toString(),
          time: 'æ™‚æ®µå”èª¿',
          location: 'ç«¹åŒ—è‡ªå®…',
          status: 'open',
          type: 'zhubei_notice'
        }];
        try {
          await db.collection(SCHEDULE_COLLECTION).doc(selectedDateKey).set({ slots: slots });
          alert("ç«¹åŒ—æ¨¡å¼å·²è¨­å®š");
        } catch (e) { alert(e.message); }
      };

      const setSpecialStatus = async (type) => {
        let label = '';
        if (type === 'abroad') label = 'å‡ºåœ‹';
        if (type === 'rest') label = 'ä¼‘æ¯';
        if (type === 'training') label = 'é€²ä¿®';

        if (!confirm(`ç¢ºå®šè¦å°‡ ${selectedDateKey} è¨­å®šç‚ºã€${label}ã€‘å—ï¼Ÿ(å°‡è¦†è“‹ç•¶æ—¥èˆŠè¨­å®š)`)) return;

        const slots = [{
          id: Date.now().toString(),
          time: 'å…¨æ—¥',
          location: '',
          status: 'closed', 
          type: type 
        }];

        try {
          await db.collection(SCHEDULE_COLLECTION).doc(selectedDateKey).set({ slots: slots });
          alert(`å·²è¨­å®šç‚º ${label}`);
        } catch (e) { alert(e.message); }
      };

      return (
        <div className="mb-6 bg-white p-3 rounded-xl border border-stone-200 shadow-sm">
          <div className="flex gap-2 mb-4 border-b border-stone-100 pb-2">
            <button onClick={() => setView('booking')} className={`flex-1 py-1 text-xs font-bold rounded-lg ${view==='booking'?'bg-[#dcb5bc] text-white':'text-stone-400'}`}>æ’ç¨‹ç®¡ç†</button>
            <button onClick={() => setView('clients')} className={`flex-1 py-1 text-xs font-bold rounded-lg ${view==='clients'?'bg-[#dcb5bc] text-white':'text-stone-400'}`}>å®¢æˆ¶ç®¡ç† (é»‘åå–®)</button>
          </div>
          {view === 'booking' ? (
            <div className="flex flex-col gap-3">
              <div className="text-xs text-center text-stone-400 mb-1">è¨­å®š {selectedDateKey} çš„æ™‚æ®µ</div>
              <div className="grid grid-cols-2 gap-3">
                <button onClick={setTamsuiSchedule} className="bg-blue-50 text-blue-600 py-3 rounded-xl text-sm font-bold border border-blue-100 shadow-sm hover:bg-blue-100 transition flex flex-col items-center justify-center gap-1">
                  <span>ğŸŒŠ æ·¡æ°´è‡ªå®…</span>
                  <span className="text-[10px] font-normal opacity-70">09:30/13:00/15:30/19:00</span>
                </button>
                <button onClick={setZhubeiSchedule} className="bg-orange-50 text-orange-600 py-3 rounded-xl text-sm font-bold border border-orange-100 shadow-sm hover:bg-orange-100 transition flex flex-col items-center justify-center gap-1">
                  <span>ğŸ‹ ç«¹åŒ—è‡ªå®…</span>
                  <span className="text-[10px] font-normal opacity-70">é¡¯ç¤ºã€Œéœ€ç§è¨Šå”èª¿ã€</span>
                </button>
              </div>
              <div className="pt-2 border-t border-dashed border-stone-200">
                 <div className="text-[10px] text-stone-400 mb-1">ğŸ“… ä¼‘å‡/ç‰¹æ®Šæ’ç¨‹</div>
                 <div className="grid grid-cols-3 gap-2">
                    <button onClick={() => setSpecialStatus('abroad')} className="bg-stone-100 text-stone-600 py-2 rounded-lg text-xs font-bold hover:bg-stone-200 flex items-center justify-center gap-1"><Icons.PlaneDoodle className="w-3.5 h-3.5"/> å‡ºåœ‹</button>
                    <button onClick={() => setSpecialStatus('rest')} className="bg-red-50 text-red-500 py-2 rounded-lg text-xs font-bold hover:bg-red-100">ä¼‘æ¯</button>
                    <button onClick={() => setSpecialStatus('training')} className="bg-indigo-50 text-indigo-500 py-2 rounded-lg text-xs font-bold hover:bg-indigo-100 flex items-center justify-center gap-1"><Icons.PenDoodle className="w-3.5 h-3.5"/> é€²ä¿®</button>
                 </div>
              </div>
              <div className="pt-2 border-t border-dashed border-stone-200">
                 <div className="text-[10px] text-stone-400 mb-1">æ‰‹å‹•æ–°å¢å€‹åˆ¥æ™‚æ®µ (ç‰¹æ®Šéœ€æ±‚ç”¨)</div>
                 <div className="flex gap-2">
                    <select value={newLocation} onChange={(e) => setNewLocation(e.target.value)} className="w-1/3 bg-stone-50 border border-stone-200 rounded-lg text-xs p-1 outline-none">
                      <option value="æ·¡æ°´è‡ªå®…">æ·¡æ°´</option>
                      <option value="ç«¹åŒ—è‡ªå®…">ç«¹åŒ—</option>
                    </select>
                    <input type="time" value={newTime} onChange={(e) => setNewTime(e.target.value)} className="w-1/3 bg-stone-50 border border-stone-200 rounded-lg text-xs p-1 outline-none" />
                    <button onClick={addSlot} className="flex-1 bg-stone-500 text-white rounded-lg text-xs font-bold"><Icons.Plus size={14} className="inline"/> æ–°å¢</button>
                 </div>
              </div>
            </div>
          ) : (
            <div className="space-y-3">
              <div className="flex gap-2">
                <input type="tel" placeholder="è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢" value={phoneSearch} onChange={e=>setPhoneSearch(e.target.value)} className="flex-1 border border-stone-200 rounded-lg p-2 text-sm outline-none"/>
                <button onClick={searchClient} className="bg-stone-500 text-white px-2 rounded-lg"><Icons.Search size={16}/></button>
                <button onClick={openBlacklistAdd} className="bg-red-400 text-white px-2 rounded-lg" title="æ–°å¢é»‘åå–®"><Icons.UserPlus size={16}/></button>
                <button onClick={openBlacklistSettings} className="bg-stone-600 text-white px-2 rounded-lg" title="ç®¡ç†é»‘åå–®"><Icons.Settings size={16}/></button>
              </div>
              
              {searchResult === 'not_found' && <div className="text-xs text-center text-stone-400">æŸ¥ç„¡æ­¤å®¢æˆ¶è³‡æ–™</div>}
              {searchResult && searchResult !== 'not_found' && (
                <div className="bg-stone-50 p-3 rounded-lg text-sm">
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-lg">{searchResult.name}</span>
                    <div className="flex gap-1">
                        {/* é¡¯ç¤ºå„²å€¼æœƒå“¡å¾½ç«  */}
                        {searchResult.isStoreMember && <span className="bg-[#dcb5bc] text-white text-[10px] px-2 py-0.5 rounded-full flex items-center gap-1"><Icons.Crown className="w-3 h-3"/> å„²å€¼æœƒå“¡</span>}
                        {searchResult.blacklist && <span className="bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full">é»‘åå–®</span>}
                    </div>
                  </div>
                  <div className="text-stone-500 text-xs mb-2">
                    ä¾†è¨ªæ¬¡æ•¸: {searchResult.visitCount || 0}
                  </div>
                  <textarea placeholder="å‚™è¨» (ä¾‹å¦‚: é ç´„æœªåˆ°...)" defaultValue={searchResult.notes || ''} onBlur={(e)=>saveNote(e.target.value)} className="w-full border border-stone-200 rounded p-1 text-xs mb-2 h-16"></textarea>
                  
                  <div className="flex gap-2 mt-2">
                      <button onClick={toggleStoreMember} className={`flex-1 py-1 rounded text-xs font-bold border transition ${searchResult.isStoreMember ? 'bg-white border-[#dcb5bc] text-[#b07d88]' : 'bg-[#dcb5bc] text-white border-transparent'}`}>
                        {searchResult.isStoreMember ? 'å–æ¶ˆå„²å€¼è³‡æ ¼' : 'ğŸ‘‘ è¨­å®šç‚ºå„²å€¼æœƒå“¡'}
                      </button>
                      <button onClick={toggleBlacklist} className={`flex-1 py-1 rounded text-xs font-bold border transition ${searchResult.blacklist ? 'bg-gray-200 text-stone-600 border-transparent' : 'bg-white border-red-500 text-red-500'}`}>
                        {searchResult.blacklist ? 'è§£é™¤é»‘åå–®' : 'åŠ å…¥é»‘åå–®'}
                      </button>
                  </div>
                </div>
              )}
            </div>
          )}
          <BlacklistManagerModal isOpen={showBlacklistManager} onClose={()=>setShowBlacklistManager(false)} initialTab={blacklistManagerTab} />
        </div>
      );
    };

    // --- æ—¥æ›†çµ„ä»¶ (åŒ…å«ç®¡ç†è€… "å·²é ç´„åˆ—è¡¨" çš„å„ªåŒ–) ---
    const CalendarView = ({ isAdmin, user }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [availability, setAvailability] = useState({});
      const [bookedList, setBookedList] = useState([]);
      const [loading, setLoading] = useState(true);
      const [newTime, setNewTime] = useState('10:00');
      const [newLocation, setNewLocation] = useState('æ·¡æ°´è‡ªå®…'); 
      const [modalOpen, setModalOpen] = useState(false);
      const [selectedSlot, setSelectedSlot] = useState(null);
      const locationColors = { 'æ–°ç«¹åœ°å€åˆ°åºœ': 'bg-red-400', 'æ–°ç«¹åˆ°åºœåœ°å€': 'bg-red-400', 'ç«¹åŒ—è‡ªå®…': 'bg-yellow-400', 'æ·¡æ°´è‡ªå®…': 'bg-green-400' };
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const firstDayOfMonth = new Date(year, month, 1).getDay();
      const monthNames = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
      const formatDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      const selectedDateKey = formatDateKey(selectedDate);

      useEffect(() => {
        const unsubscribe = db.collection(SCHEDULE_COLLECTION).onSnapshot((snapshot) => {
          const data = {};
          const allBooked = [];
          snapshot.forEach(doc => {
            const slots = doc.data().slots || [];
            data[doc.id] = slots;
            slots.forEach(slot => { if (slot.status === 'booked') allBooked.push({ date: doc.id, ...slot }); });
          });
          setAvailability(data);
          
          // [å„ªåŒ–] è‡ªå‹•éæ¿¾æ‰ã€Œä»Šå¤©ä»¥å‰ã€çš„é ç´„ (åªé¡¯ç¤ºä»Šå¤©åŠæœªä¾†çš„å¾…æé†’é …ç›®)
          const now = new Date();
          // æ³¨æ„ï¼šç‚ºç¢ºä¿ä¸æ¼æ‰ä»Šå¤©çš„é ç´„ï¼Œå°‡ä»Šå¤©çš„æ™‚é–“è¨­ç‚º 00:00:00 é€²è¡Œæ¯”å°
          const todayStr = now.toISOString().split('T')[0];
          
          const filteredBooked = allBooked.filter(slot => {
             return slot.date >= todayStr;
          }).sort((a,b) => (a.date + a.time).localeCompare(b.date + b.time));

          setBookedList(filteredBooked);
          setLoading(false);
        });
        return () => unsubscribe();
      }, [user]);

      const addSlot = async () => {
        const slotData = { id: Date.now().toString(), time: newTime, location: newLocation, status: 'open' };
        try { await db.collection(SCHEDULE_COLLECTION).doc(selectedDateKey).set({ slots: firebase.firestore.FieldValue.arrayUnion(slotData) }, { merge: true }); } catch (e) { alert(e.message); }
      };

      const updateSlotStatus = async (slot, newStatus, clientName = '') => {
        try {
          const docRef = db.collection(SCHEDULE_COLLECTION).doc(selectedDateKey);
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            const updatedSlots = docSnap.data().slots.map(s => s.id === slot.id ? { ...s, status: newStatus, clientName } : s);
            await docRef.set({ slots: updatedSlots });
          }
        } catch (e) { console.error(e); }
      };

      const removeSlot = async (slot) => {
        try { await db.collection(SCHEDULE_COLLECTION).doc(selectedDateKey).update({ slots: firebase.firestore.FieldValue.arrayRemove(slot) }); } catch (e) { console.error(e); }
      };

      // [æ–°å¢] æ¨™è¨˜ç‚ºå·²æé†’ (toggleRemindStatus)
      const toggleRemindStatus = async (slot) => {
        try {
          const docRef = db.collection(SCHEDULE_COLLECTION).doc(slot.date);
          const docSnap = await docRef.get();
          if (docSnap.exists) {
            // åˆ‡æ› isReminded ç‹€æ…‹ (true <-> false)
            const updatedSlots = docSnap.data().slots.map(s => {
                if (s.id === slot.id) {
                    return { ...s, isReminded: !s.isReminded };
                }
                return s;
            });
            await docRef.update({ slots: updatedSlots });
          }
        } catch (e) { 
           console.error(e);
           alert("æ›´æ–°ç‹€æ…‹å¤±æ•—"); 
        }
      };

      const handleUserClick = (slot) => { 
        if (slot.type === 'abroad' || slot.type === 'rest' || slot.type === 'training') {
           setSelectedSlot(slot);
           return; 
        }
        // ç«¹åŒ—è‡ªå®…/éœ€å”èª¿æ™‚æ®µ -> è·³è½‰ LINE
        if (slot.isVirtual || slot.type === 'zhubei_notice' || slot.time === 'æ™‚æ®µå”èª¿' || slot.location === 'ç«¹åŒ—è‡ªå®…') {
           const textToCopy = `[æœŸæœ›é ç´„æ™‚é–“:] ${slot.date || ''}\n[é ç´„é …ç›®:] `;
           const textArea = document.createElement("textarea");
           textArea.value = textToCopy;
           document.body.appendChild(textArea);
           textArea.select();
           try { document.execCommand('copy'); } catch (e) {}
           document.body.removeChild(textArea);

           alert("å·²è‡ªå‹•è¤‡è£½é ç´„æ ¼å¼ï¼\nè«‹è·³è½‰è‡³ LINE å¾Œã€Œè²¼ä¸Šã€ä¸¦å¡«å¯«å‚³é€ã€‚\n\nâš ï¸ é—†å¨˜å°æé†’ï¼š\næœƒç›¡å¯èƒ½å®‰æ’æ™‚é–“ï¼Œä½†å¦‚æœçœŸçš„å–¬ä¸åˆ°å¯ä»¥é…åˆçš„æ™‚é–“ï¼Œå¾ˆæŠ±æ­‰...ä¹Ÿè¬è¬å¦³é¡˜æ„çµ¦æˆ‘æ©Ÿæœƒï¼Œå¸Œæœ›æœªä¾†é‚„æ˜¯èƒ½å¤ æœå‹™åˆ°å¦³â¤ï¸");
           window.location.href = "https://lin.ee/49zZehk";
           return;
        }
        setSelectedSlot(slot); 
        setModalOpen(true); 
      };

      const handleAdminBook = (slot) => { const name = prompt("è«‹è¼¸å…¥é ç´„å®¢äººå§“åï¼š"); if (name) updateSlotStatus(slot, 'booked', name); };
      const changeMonth = (offset) => setCurrentDate(new Date(year, month + offset, 1));
      
      const sendLineReminder = (slot) => {
        const msg = `Hi ${slot.clientName}ï¼Œæé†’æ‚¨æ˜å¤© ${slot.date} ${slot.time} åœ¨ ${slot.location} æœ‰é ç´„å–”ï¼\nè‹¥éœ€æ›´æ”¹æ™‚é–“è«‹æå‰å‘ŠçŸ¥ï¼Œè¬è¬â¤ï¸\n(ç•¶å¤©è‹¥å¸¶å¦éœ€åŠ æ”¶$100å¸å¦è²»)`;
        const textArea = document.createElement("textarea");
        textArea.value = msg;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert("æé†’è¨Šæ¯å·²è¤‡è£½ï¼å°‡é–‹å•Ÿ LINE");
        window.location.href = "https://lin.ee/49zZehk";
      };

      const addToGoogleCalendar = (slot) => {
        const startStr = slot.date.replace(/-/g, '') + 'T' + (slot.time === 'æ™‚æ®µå”èª¿' || slot.time === 'å…¨æ—¥å¯ç´„' ? '090000' : slot.time.replace(':', '') + '00');
        const dateObj = new Date(`${slot.date}T${(slot.time === 'æ™‚æ®µå”èª¿' || slot.time === 'å…¨æ—¥å¯ç´„') ? '09:00' : slot.time}:00`);
        dateObj.setMinutes(dateObj.getMinutes() + 150);
        const endHours = String(dateObj.getHours()).padStart(2, '0');
        const endMinutes = String(dateObj.getMinutes()).padStart(2, '0');
        const endStr = slot.date.replace(/-/g, '') + 'T' + endHours + endMinutes + '00';
        
        const text = encodeURIComponent(`é ç´„: ${slot.clientName || 'å®¢æˆ¶'}`);
        const details = encodeURIComponent(`é›»è©±: ${slot.clientPhone || ''}\né …ç›®: ${slot.services || ''}`);
        const location = encodeURIComponent(slot.location || '');
        
        const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${startStr}/${endStr}&details=${details}&location=${location}`;
        window.open(url, '_blank');
      };

      return (
        <div className="w-full">
           <div className="flex justify-between items-center mb-4 px-2">
             <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-stone-100 rounded-full"><Icons.ChevronDown className="rotate-90 text-stone-500" /></button>
             <h3 className="text-lg font-bold text-stone-700">{year}å¹´ {monthNames[month]}</h3>
             <button onClick={() => changeMonth(1)} className="p-1 hover:bg-stone-100 rounded-full"><Icons.ChevronDown className="-rotate-90 text-stone-500" /></button>
           </div>
           
           <div className="flex flex-wrap justify-center gap-x-4 gap-y-2 mb-4 text-[10px] text-stone-500">
              <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-400"></span>æ·¡æ°´è‡ªå®…</div>
              <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-400"></span>ç«¹åŒ—è‡ªå®… (éœ€å”èª¿)</div>
           </div>

           <div className="grid grid-cols-7 gap-1 mb-6 text-center">
             {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => <div key={d} className="text-xs text-[#b07d88] font-bold mb-2">{d}</div>)}
             {Array.from({ length: firstDayOfMonth }).map((_, i) => <div key={`empty-${i}`} className="aspect-square"></div>)}
             {Array.from({ length: daysInMonth }).map((_, i) => {
               const d = i + 1;
               const dateObj = new Date(year, month, d);
               const dateKey = formatDateKey(dateObj);
               const isSelected = selectedDate.getDate() === d && selectedDate.getMonth() === month;
               const today = new Date();
               today.setHours(0,0,0,0);
               const isPast = dateObj < today;
               
               const dateSlots = availability[dateKey] || [];
               const specialSlot = dateSlots.find(s => ['abroad', 'rest', 'training'].includes(s.type));
               const hasSpecificSlots = dateSlots.length > 0; 
               const isZhubeiDefault = !hasSpecificSlots; 
               const isFull = hasSpecificSlots && !specialSlot && !dateSlots.some(s => s.status === 'open');

               return (
                 <button key={d} onClick={() => { setSelectedDate(dateObj); if(specialSlot) handleUserClick(specialSlot); }} disabled={isPast}
                   className={`aspect-square rounded-full flex flex-col items-center justify-center relative transition ${isSelected ? 'bg-[#dcb5bc] text-white shadow-md' : 'hover:bg-stone-100 text-stone-600'} ${isPast ? 'opacity-50 cursor-not-allowed' : ''} ${specialSlot ? 'cursor-not-allowed' : ''}`}
                 >
                   <span className={`text-sm font-medium relative`}>{d}</span>
                   {!isPast && !specialSlot && (
                       <div className="absolute bottom-1.5 flex gap-0.5">
                          {hasSpecificSlots ? (
                              <span className="w-1.5 h-1.5 rounded-full bg-blue-400 ring-1 ring-white" />
                          ) : (
                              <span className="w-1.5 h-1.5 rounded-full bg-yellow-400 ring-1 ring-white" />
                          )}
                       </div>
                   )}
                   {isPast && (
                        <div className="absolute inset-0 flex items-center justify-center bg-stone-100/50 rounded-full">
                            <span className="text-stone-400 font-bold text-lg">âœ•</span>
                        </div>
                   )}
                   {!isPast && specialSlot && (
                     <div className="absolute inset-0 flex items-center justify-center rounded-full bg-white/80">
                       {specialSlot.type === 'abroad' && <Icons.PlaneDoodle className="text-stone-500 w-5 h-5" />}
                       {specialSlot.type === 'rest' && <span className="text-red-500/80 font-bold text-sm">ä¼‘</span>}
                       {specialSlot.type === 'training' && <Icons.PenDoodle className="text-indigo-500 w-4 h-4" />}
                     </div>
                   )}
                   {!isPast && !specialSlot && isFull && (
                        <div className="absolute inset-0 flex items-center justify-center bg-white/60 rounded-full">
                            <span className="text-red-500 font-bold text-sm">æ»¿</span>
                        </div>
                   )}
                 </button>
               );
             })}
           </div>
           
           <div className="bg-[#fdfbf7] border-t-2 border-dashed border-stone-200 pt-4">
             <div className="text-center mb-4"><span className="bg-stone-200 text-stone-600 px-3 py-1 rounded-full text-xs font-bold">{selectedDateKey}</span></div>
             {isAdmin && <AdminPanel selectedDateKey={selectedDateKey} newTime={newTime} setNewTime={setNewTime} newLocation={newLocation} setNewLocation={setNewLocation} addSlot={addSlot} />}
             <div className="space-y-2">
               {loading ? <p className="text-center text-stone-400 text-sm">è¼‰å…¥ä¸­...</p> : 
                 (() => {
                    const currentSlots = availability[selectedDateKey] || [];
                    const specialSlot = currentSlots.find(s => ['abroad', 'rest', 'training'].includes(s.type));

                    if (specialSlot) {
                       let label = '';
                       let icon = null;
                       if(specialSlot.type === 'abroad') { 
                           label = 'å‡ºåœ‹æ”¾é¢¨å»!å›è¨Šæ¯æœƒæ¯”è¼ƒæ…¢'; 
                           icon = <Icons.PlaneDoodle className="w-8 h-8 text-stone-400 mb-2"/>; 
                       }
                       if(specialSlot.type === 'rest') { 
                           label = 'æœ¬æ—¥ä¼‘æ¯'; 
                           icon = <span className="text-3xl font-bold text-red-400 mb-2">ä¼‘</span>; 
                       }
                       if(specialSlot.type === 'training') { 
                           label = 'æˆ‘åˆå»é€²ä¿®äº†!ä¸‹èª²æ‰æœƒå›è¨Šæ¯'; 
                           icon = <Icons.PenDoodle className="w-8 h-8 text-indigo-400 mb-2"/>; 
                       }

                       return (
                          <div className="bg-white border-2 border-dashed border-stone-300 rounded-2xl p-8 flex flex-col items-center justify-center text-stone-500">
                             {icon}
                             <span className="font-bold text-lg text-center">{label}</span>
                             {isAdmin && <button onClick={() => removeSlot(specialSlot)} className="text-xs text-red-400 underline mt-4 bg-red-50 px-3 py-1 rounded-full">ç§»é™¤æ­¤ç‹€æ…‹</button>}
                          </div>
                       );
                    }
                    
                    if (currentSlots.length > 0) {
                        return currentSlots.sort((a, b) => a.time.localeCompare(b.time)).map((slot, index) => (
                           <div key={index} className={`bg-white border border-stone-200 rounded-xl p-3 flex justify-between items-center shadow-sm ${slot.status === 'booked' ? 'opacity-60 bg-stone-100' : ''}`}>
                             <div className="flex flex-col">
                               <div className="flex items-center gap-2 text-stone-700 font-bold text-lg">
                                 <Icons.Clock size={16} className="text-[#b07d88]" />
                                 <span className={slot.status === 'booked' ? 'line-through text-stone-400' : ''}>{slot.time}</span>
                                 {slot.status === 'booked' && <span className="bg-stone-500 text-white text-[10px] px-2 rounded-full">å·²é ç´„</span>}
                               </div>
                               <div className="flex items-center gap-2 text-stone-500 text-xs mt-1">
                                 <Icons.MapPin size={12} className={locationColors[slot.location]?.replace('bg-', 'text-') || 'text-stone-400'} />{slot.location}
                               </div>
                               {isAdmin && slot.status === 'booked' && <div className="text-xs text-[#b07d88] font-bold mt-1">å®¢ï¼š{slot.clientName}</div>}
                             </div>
                             {isAdmin ? (
                               <div className="flex gap-2">
                                 {slot.status === 'open' && <button onClick={() => handleAdminBook(slot)} className="bg-green-50 text-green-600 p-2 rounded-lg text-xs font-bold">ç™»è¨˜</button>}
                                 {slot.status === 'booked' && <button onClick={() => updateSlotStatus(slot, 'open')} className="bg-yellow-50 text-yellow-600 p-2 rounded-lg text-xs font-bold">å–æ¶ˆ</button>}
                                 <button onClick={() => removeSlot(slot)} className="bg-red-50 text-red-500 p-2 rounded-lg"><Icons.Trash2 size={16} /></button>
                               </div>
                             ) : (
                               slot.status === 'open' ? 
                               <button onClick={() => handleUserClick(slot)} className="bg-[#fae8eb] text-[#b07d88] px-4 py-2 rounded-lg text-sm font-bold hover:bg-[#dcb5bc] hover:text-white transition">
                                 {slot.type === 'zhubei_notice' ? 'é ç´„/è©¢å•' : 'é ç´„'}
                               </button> :
                               <button disabled className="bg-stone-100 text-stone-400 px-4 py-2 rounded-lg text-sm font-bold">å·²æ»¿</button>
                             )}
                           </div>
                        ));
                    } else {
                        const virtualZhubeiSlot = {
                            id: 'virtual_zhubei',
                            time: 'å…¨æ—¥å¯ç´„',
                            location: 'ç«¹åŒ—è‡ªå®…',
                            status: 'open',
                            isVirtual: true
                        };
                        return (
                           <div className="bg-white border border-yellow-200 rounded-xl p-3 flex justify-between items-center shadow-sm">
                             <div className="flex flex-col">
                               <div className="flex items-center gap-2 text-stone-700 font-bold text-lg">
                                 <Icons.Clock size={16} className="text-yellow-500" />
                                 <span>å…¨æ—¥å¯ç´„ (éœ€å”èª¿)</span>
                               </div>
                               <div className="flex items-center gap-2 text-stone-500 text-xs mt-1">
                                 <Icons.MapPin size={12} className="text-yellow-500" />ç«¹åŒ—è‡ªå®…
                               </div>
                             </div>
                             {isAdmin ? (
                                <div className="text-xs text-stone-400 italic">é è¨­ç«¹åŒ—æ¨¡å¼ (ç„¡å…·é«”æ™‚æ®µ)</div>
                             ) : (
                                <button onClick={() => handleUserClick(virtualZhubeiSlot)} className="bg-yellow-50 text-yellow-600 border border-yellow-200 px-4 py-2 rounded-lg text-sm font-bold hover:bg-yellow-100 transition">
                                  é ç´„/è©¢å•
                                </button>
                             )}
                           </div>
                        );
                    }
                 })()
               }
             </div>
           </div>
           
           {/* é ç´„åˆ—è¡¨ (å·²éæ¿¾éæœŸé …ç›® + æ–°å¢æ‰“å‹¾åŠŸèƒ½) */}
           {isAdmin && bookedList.length > 0 && (
             <div className="mt-8 border-t-2 border-dashed border-stone-300 pt-6">
               <h3 className="text-center font-bold text-stone-600 mb-4 flex justify-center gap-2">å·²é ç´„åˆ—è¡¨ (å¾…æé†’)</h3>
               <div className="space-y-2">
                 {bookedList.map((slot, i) => (
                   <div key={i} className={`bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm flex justify-between items-center ${slot.isReminded ? 'opacity-50 grayscale' : ''}`}>
                     <div className="flex items-center gap-3">
                       {/* [æ–°å¢] æ‰“å‹¾ç¢ºèªéˆ• */}
                       <button onClick={() => toggleRemindStatus(slot)} className={`w-6 h-6 rounded border-2 flex items-center justify-center transition-colors ${slot.isReminded ? 'bg-[#06c755] border-[#06c755] text-white' : 'border-stone-300 hover:border-[#06c755] bg-white'}`}>
                          {slot.isReminded && <Icons.Check />}
                       </button>

                       <div className={slot.isReminded ? 'line-through text-stone-400' : ''}>
                         <div className="font-bold text-stone-700">{slot.date} {slot.time}</div>
                         <div className="text-xs text-stone-500">{slot.location} | å®¢ï¼š{slot.clientName}</div>
                       </div>
                     </div>
                     <div className="flex gap-2">
                       <button onClick={() => addToGoogleCalendar(slot)} className="bg-blue-500 text-white px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-1" title="åŠ å…¥ Google è¡Œäº‹æ›†">
                         <Icons.Calendar size={12} /> Google
                       </button>
                       <button onClick={() => sendLineReminder(slot)} className="bg-[#06c755] text-white px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-1">
                         <Icons.Send size={12} /> LINE
                       </button>
                     </div>
                   </div>
                 ))}
               </div>
             </div>
           )}
           <BookingModal isOpen={modalOpen} onClose={() => setModalOpen(false)} slot={selectedSlot} dateKey={selectedDateKey} />
           <BackgroundDoodles />
        </div>
      );
    };

    // [æ–°å¢] åƒ¹ç›®è¡¨å¡ç‰‡
    const PriceCard = ({ title, generalPrice, memberPrice, note, isCombo }) => (
      <div className={`border-2 border-stone-200 bg-white rounded-xl p-4 shadow-sm mb-3 ${isCombo ? 'border-[#dcb5bc]/50 bg-[#fff5f7]' : ''}`}>
        <div className="flex justify-between items-start">
           <div>
             <h4 className="font-bold text-stone-700 text-lg flex items-center gap-2">
               {isCombo && <Icons.Sparkles className="w-4 h-4 text-yellow-400" />}
               {title}
             </h4>
             {note && <p className="text-xs text-stone-400 mt-1">{note}</p>}
           </div>
        </div>
        
        <div className="mt-4 flex items-center justify-between border-t border-dashed border-stone-100 pt-3">
           <div className="text-left">
             <div className="text-xs text-stone-400 mb-0.5">ä¸€èˆ¬ / é«”é©—åƒ¹</div>
             <div className="font-medium text-stone-600">{generalPrice}</div>
           </div>
           <div className="text-right">
             <div className="text-xs text-[#b07d88] font-bold mb-0.5 flex items-center justify-end gap-1"><Icons.Heart className="w-3 h-3 fill-[#b07d88]"/> æœƒå“¡åƒ¹</div>
             <div className="font-bold text-xl text-[#b07d88]">{memberPrice}</div>
           </div>
        </div>
      </div>
    );

    // [æ–°å¢] å„²å€¼æ–¹æ¡ˆå¡ç‰‡
    const StoredValueCard = ({ title, price, gift, target, colorClass }) => (
      <div className={`border-2 rounded-xl p-4 mb-3 relative overflow-hidden bg-white ${colorClass}`}>
        <div className="relative z-10">
          <div className="flex justify-between items-center mb-2">
            <h4 className="font-bold text-stone-700 text-lg">{title}</h4>
            <span className="font-bold text-xl text-[#b07d88]">{price}</span>
          </div>
          <div className="bg-[#fff5f5] rounded-lg p-2 mb-2">
            <span className="text-xs font-bold text-red-400 border border-red-200 px-1 rounded mr-2 bg-white">è´ˆé€</span>
            <span className="text-sm text-stone-600 font-medium">{gift}</span>
          </div>
          <p className="text-xs text-stone-400"><span className="font-bold">æ¨è–¦ï¼š</span>{target}</p>
        </div>
      </div>
    );

    // [æ–°å¢] åˆ†é å…§å®¹ï¼šåƒ¹ç›®è¡¨
    const PriceView = () => (
      <div className="space-y-2 tab-content">
        <div className="text-center mb-4">
           <h2 className="text-xl font-bold text-stone-600 mb-1">Service Menu</h2>
           <p className="text-xs text-stone-400">å„²å€¼æœƒå“¡äº«å°ˆå±¬å„ªæƒ </p>
        </div>
        
        <PriceCard 
          title="ä¸Šç«æ¯›ç®¡ç†" 
          generalPrice={<span>$999 <span className="text-xs text-stone-400">(é¦–æ¬¡ $699)</span></span>}
          memberPrice="$850"
          note="å«ç«æ¯›æ³¡æ³¡æ´— + æ»‹é¤Šä¿®è­·"
        />
        <PriceCard 
          title="ä¸‹ç«æ¯›ç®¡ç†" 
          generalPrice="$500"
          memberPrice={<span>$400 <span className="text-[10px] opacity-70 block">(åŠ è³¼åƒ¹$250)</span></span>}
        />
        <PriceCard 
          title="é‡ç”Ÿçœ‰é›•å¡‘" 
          generalPrice={<span>$999 <span className="text-xs text-stone-400">(é¦–æ¬¡ $699)</span></span>}
          memberPrice="$850"
        />
        <PriceCard 
          title="è€€çœ¼çµ„åˆ (çœ‰+ç«)" 
          generalPrice={<span>åŸåƒ¹æŠ˜ <span className="text-red-400 font-bold">$100</span></span>}
          memberPrice="$1600"
          isCombo={true}
          note="ä¸Šç«æ¯›ç®¡ç† + é‡ç”Ÿçœ‰é›•å¡‘"
        />

        <div className="mt-6 bg-stone-100 rounded-xl p-4 text-xs text-stone-500">
          <h5 className="font-bold mb-2 flex items-center gap-2"><Icons.Star className="w-3 h-3 text-yellow-400 fill-yellow-400"/> åŠ è³¼é …ç›®</h5>
          <div className="flex justify-between mb-1"><span>æ¿ƒé»‘é¤Šè­· (ä¸Š/ä¸‹)</span> <span>+$200 / $100</span></div>
          <div className="flex justify-between"><span>å¸å¦è²» (è‹¥å¸¶å¦)</span> <span className="text-red-400">+$100</span></div>
        </div>

        {/* å„²å€¼æ–¹æ¡ˆå€å¡Š */}
        <div className="mt-8 mb-4 relative">
            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-stone-300 border-dashed"></div></div>
            <div className="relative flex justify-center text-sm"><span className="px-2 bg-[#fdfbf7] text-stone-500 font-bold">ğŸ’ å„²å€¼å„ªæƒ æ–¹æ¡ˆ</span></div>
        </div>

        <StoredValueCard 
          title="å°è³‡é«”é©—çµ„"
          price="$3,000"
          gift="è´ˆé€ $200 å„²å€¼é‡‘"
          target="å‰›éé«”é©—æœŸã€æƒ³ç©©å®šä¿é¤Šçš„å®¢æˆ¶"
          colorClass="border-stone-200"
        />
        <StoredValueCard 
          title="ç¶“å…¸äº®çœ¼çµ„"
          price="$5,000"
          gift="è´ˆé€ $500 å„²å€¼é‡‘ + ç«æ¯›é›¨è¡£ä¸€æ”¯"
          target="ç«æ¯›çœ‰æ¯›åŒæ™‚ç®¡ç†ã€ç†Ÿå®¢"
          colorClass="border-[#dcb5bc]"
        />
        <StoredValueCard 
          title="æ¥µè‡´å¯µæ„›çµ„"
          price="$10,000"
          gift="è´ˆé€ $1,500 å„²å€¼é‡‘ + ç«æ¯›æ»‹é¤Šæ¶²ä¸€æ”¯"
          target="æ ¸å¿ƒéµç²‰ï¼Œé ç¹³ä¸€å¹´ä»½è²»ç”¨"
          colorClass="border-yellow-400/50 bg-yellow-50/30"
        />
      </div>
    );

    // [æ–°å¢] åˆ†é å…§å®¹ï¼šQ&A
    const QAView = () => (
      <div className="space-y-3 tab-content">
        <div className="text-center mb-4"><h2 className="text-xl font-bold text-stone-600">Q & A</h2></div>
        <AccordionItem q="1. ç¿¹ç«ç®¡ç†/é‡ç”Ÿçœ‰é›•å¡‘å¯ä»¥ç¶­æŒå¤šä¹…ï¼Ÿ" a="æ¯å€‹äººçš„æ¯›é«®ç”Ÿé•·é€±æœŸèˆ‡ä¿é¤Šç¿’æ…£ä¸åŒã€‚ä¸€èˆ¬ä¾†èªªï¼Œç¿¹ç«ç®¡ç†ç´„å¯ç¶­æŒ 4-8 é€±ï¼›é‡ç”Ÿçœ‰é›•å¡‘ç´„å¯ç¶­æŒ 4-6 é€±ã€‚" />
        <AccordionItem q="2. ç«æ¯›ç®¡ç†è·Ÿè§’è›‹ç™½æ˜¯ä¸€æ¨£çš„å—ï¼Ÿ" a="é›–ç„¶åŸç†ç›¸ä¼¼ï¼Œä½†ä½¿ç”¨çš„ç”¢å“èˆ‡æŠ€è¡“å¤§ä¸åŒå–”ï¼å‚³çµ±è§’è›‹ç™½è¼ƒå®¹æ˜“é€ æˆç«æ¯›ä¹¾æ¾€ï¼›Bianca çš„ã€Œç«æ¯›ç®¡ç†ã€ä½¿ç”¨æº«å’Œä¸”å«é«˜ä¿é¤Šæˆåˆ†çš„ç”¢å“ï¼Œåœ¨èª¿æ•´æ¯›æµæ²åº¦çš„åŒæ™‚ï¼ŒåŒæ­¥çµ¦äºˆç«æ¯›æ»‹é¤Šä¿®è­·ï¼Œæ›´åŠ å®‰å…¨ä¸å‚·ç«æ¯›ã€‚" />
        <AccordionItem q="3. ç«æ¯›ç®¡ç†å¾Œæ˜¯ä¸æ˜¯ç«æ¯›æ¯”è¼ƒè„†å¼±æ˜“æ–·ï¼Ÿ" a="ä¸æœƒçš„ã€‚å› ç‚ºæˆ‘å€‘é¸ç”¨çš„ç”¢å“å«æœ‰è§’è›‹ç™½èˆ‡ä¿æ¿•æˆåˆ†ï¼Œæ“ä½œéç¨‹æº«å’Œã€‚åªè¦æ“ä½œæ­£ç¢ºï¼Œä¸¦ä¸æœƒå°è‡´ç«æ¯›è®Šè„†å¼±ã€‚åè€Œå› ç‚ºæ¯›æµæ•´é½Šäº†ï¼Œè¦–è¦ºä¸Šæœƒè¦ºå¾—ç«æ¯›æ›´å¼·éŸŒå¥åº·ã€‚" />
        <AccordionItem q="4. ç‚ºä»€éº¼ä¸€æ®µæ™‚é–“å¾Œï¼Œç«æ¯›æœƒçœ‹èµ·ä¾†å‡Œäº‚ï¼Œæ˜¯å—æå—ï¼Ÿ" a="é€™ä¸æ˜¯å—æå–”ï¼é€™æ˜¯å› ç‚ºç«æ¯›æœ‰ã€Œç”Ÿé•·é€±æœŸã€ã€‚æ–°é•·å‡ºä¾†çš„ç›´ç«æ¯›ï¼ˆåŸç”Ÿç«æ¯›ï¼‰èˆ‡åŸæœ¬åšéæ²ç¿¹ç®¡ç†çš„ç«æ¯›æ··åœ¨ä¸€èµ·ï¼Œäº¤éŒ¯æ’åˆ—ä¸‹æ‰æœƒçœ‹èµ·ä¾†å‡Œäº‚ã€‚é€™æ™‚å€™åªè¦é ç´„å›ä¾†é‡æ–°æ•´ç†ï¼Œå°±èƒ½æ¢å¾©å®Œç¾æ²åº¦å›‰ï¼" />
        <AccordionItem q="5. ç«æ¯›ç®¡ç†å¯ä»¥è®“ç«æ¯›è®Šå¥åº·ï¼Œè®Šé•·å—ï¼Ÿ" a="ç«æ¯›ç®¡ç†ä¸»è¦æ˜¯é€éèª¿æ•´æ¯›æµæ–¹å‘èˆ‡æ²åº¦ï¼Œè®“ç«æ¯›åœ¨è¦–è¦ºä¸Šçœ‹èµ·ä¾†ã€Œè®Šé•·ã€è®Šç¿¹ã€è®Šæ¿ƒå¯†ã€ï¼Œå°±åƒåˆ·äº†ç«æ¯›è†ä¸€æ¨£æœ‰ç¥ã€‚è‹¥å¸Œæœ›åŸç”Ÿç«æ¯›æœ¬èº«è®Šé•·ã€è®Šç²—å£¯ï¼Œå»ºè­°æ­é…å±…å®¶ä½¿ç”¨çš„ã€Œç«æ¯›å¢é•·æ¶²ã€å‹¤å‹ä¿é¤Šå–”ï¼" />
        
        {/* ç¬¬6é»ï¼šåµŒå…¥ç«æ¯›æ•´ç†æ•™å­¸åœ–æ–‡ */}
        <AccordionItem 
            q="6. å›å»å¾Œæ€éº¼ä¿é¤Šï¼Ÿ" 
            a={
                <div>
                    æ–½ä½œå¾Œ 24 å°æ™‚å…§è«‹ä¿æŒä¹¾ç‡¥ã€å‹¿ç¢°æ°´ã€‚æ—¥å¸¸æ´—è‡‰å¾Œï¼Œå»ºè­°ä½¿ç”¨å†·é¢¨å°‡ç«æ¯›å¹ä¹¾ã€‚
                    <div className="mt-4 flex flex-col gap-4">
                        <div className="bg-white p-3 rounded-xl border border-stone-200">
                             <div className="flex items-center gap-2 mb-2">
                                <span className="bg-[#b07d88] text-white text-xs px-2 py-1 rounded">å–œæ­¡æŸç‹€æ„Ÿ</span>
                                <span className="text-xs text-stone-400">(Manhwa Style)</span>
                             </div>
                             <EyelashTutorialDoodle mode="bundle" />
                             <p className="mt-2 text-xs text-stone-600">ä½¿ç”¨ç«æ¯›å®šå‹æ¶²ï¼Œåˆ·å…·<span className="font-bold text-[#b07d88]">ã€Œç¸±å‘ã€å·¦å³åˆ·</span>ï¼Œå¯æ­é…é‘·å­æ•´ç†æˆæŸã€‚</p>
                        </div>
                        <div className="bg-white p-3 rounded-xl border border-stone-200">
                             <div className="flex items-center gap-2 mb-2">
                                <span className="bg-stone-500 text-white text-xs px-2 py-1 rounded">å–œæ­¡è‡ªç„¶æ„Ÿ</span>
                                <span className="text-xs text-stone-400">(Natural Style)</span>
                             </div>
                             <EyelashTutorialDoodle mode="natural" />
                             <p className="mt-2 text-xs text-stone-600">ä½¿ç”¨ç«æ¯›å®šå‹æ¶²ï¼Œåˆ·å…·<span className="font-bold text-stone-600">ã€Œå¹³è¡Œã€å‘ä¸Šæ¢³é †</span>ï¼Œæ ¹æ ¹åˆ†æ˜ã€‚</p>
                        </div>
                    </div>
                </div>
            }
        />
      </div>
    );

    // [æ–°å¢] åˆ†é å…§å®¹ï¼šé ç´„é ˆçŸ¥
    const NoticeView = () => (
      <div className="tab-content">
        <div className="text-center mb-4"><h2 className="text-xl font-bold text-stone-600">Notice</h2></div>
        <div className="bg-[#f0ecec] p-6 rounded-[2rem] relative">
            <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-6 bg-[#dcb5bc]/60 rotate-2"></div>
            <h3 className="text-center font-bold text-stone-600 mb-4">é ç´„å‰è«‹è©³é–±</h3>
            <ul className="space-y-3 text-sm text-stone-600 leading-relaxed list-none">
                {[
                "é ç´„è«‹ä¿ç•™ <strong>2-2.5 å°æ™‚</strong> çš„æ“ä½œæ™‚é–“ï¼Œè«‹å‹¿è¶•æ™‚é–“ã€‚",
                "ç•¶å¤©è«‹ç´ çœ¼å‰ä¾†ï¼Œè‹¥æœ‰çœ¼å¦éœ€å¸é™¤å°‡é…Œæ”¶ <strong class='text-red-400'>$100 æ¸…æ½”è²»</strong>ã€‚",
                "é²åˆ°è¶…é <strong>15åˆ†é˜</strong> è‡ªå‹•å–æ¶ˆé ç´„ï¼Œä¸å¦è¡Œé€šçŸ¥ã€‚",
                "è‹¥éœ€æ›´æ”¹é ç´„è«‹ <strong>2å¤©å‰</strong> å‘ŠçŸ¥ï¼Œç„¡æ•…æœªåˆ°è€…å°‡åˆ—å…¥é»‘åå–®ã€‚",
                "çœ¼ç›è¿‘æœŸæœ‰é–‹åˆ€ã€é›·å°„æˆ–éæ•ç™¼ç‚è€…ï¼Œè«‹äº‹å…ˆå‘ŠçŸ¥ã€‚"
                ].map((text, i) => (
                <li key={i} className="flex gap-2"><span className="text-[#dcb5bc] font-bold">{i+1}.</span><span dangerouslySetInnerHTML={{__html: text}}></span></li>
                ))}
            </ul>
        </div>
        <div className="flex gap-3 mt-4 px-2">
          <a href="https://www.instagram.com/bianca_eye.studio?igsh=aTl5N21sdmdjNjQ0&utm_source=qr" target="_blank" className="flex-1 bg-white border-2 border-pink-200 text-stone-600 py-2 rounded-xl flex items-center justify-center gap-2 hover:bg-pink-50 transition">
            <Icons.Instagram className="w-5 h-5 text-[#E1306C]" />
            <span className="text-sm font-bold">IG ä½œå“é›†</span>
          </a>
          <a href="https://lin.ee/49zZehk" target="_blank" className="flex-1 bg-white border-2 border-green-200 text-stone-600 py-2 rounded-xl flex items-center justify-center gap-2 hover:bg-green-50 transition">
            <Icons.MessageCircle className="w-5 h-5 text-[#06c755]" />
            <span className="text-sm font-bold">LINE è«®è©¢</span>
          </a>
        </div>
      </div>
    );

    const AccordionItem = ({ q, a }) => {
      const [isOpen, setIsOpen] = useState(false);
      return (
        <div className="border-2 border-stone-200 rounded-2xl bg-white overflow-hidden transition-all duration-300">
          <button onClick={() => setIsOpen(!isOpen)} className="w-full flex justify-between items-center p-4 text-left hover:bg-stone-50 transition">
            <div className="flex items-center gap-3"><span className="bg-[#dcb5bc] text-white text-xs font-bold px-2 py-1 rounded-full">Q</span><span className="font-medium text-stone-700">{q}</span></div>
            {isOpen ? <Icons.ChevronUp className="text-stone-400 w-5 h-5" /> : <Icons.ChevronDown className="text-stone-400 w-5 h-5" />}
          </button>
          {isOpen && <div className="px-4 pb-4 pt-0 text-sm text-stone-500 leading-relaxed border-t border-stone-100"><div className="mt-3 flex gap-3"><span className="text-[#b07d88] font-bold text-lg leading-none mt-[-2px]">A.</span><div className="flex-1">{a}</div></div></div>}
        </div>
      );
    };

    function App() {
      const [isMenuOpen, setIsMenuOpen] = useState(false);
      const [activeTab, setActiveTab] = useState('price');
      const [isAdmin, setIsAdmin] = useState(false);
      const [showAdminLogin, setShowAdminLogin] = useState(false);
      const [adminEmailInput, setAdminEmailInput] = useState(''); 
      const [adminPassword, setAdminPassword] = useState('');
      const [loadingAuth, setLoadingAuth] = useState(true);
      const [isLookupOpen, setIsLookupOpen] = useState(false);
      
      const ADMIN_EMAIL = "bianca.studio2026@gmail.com"; 

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          if (user) {
            if (user.email === ADMIN_EMAIL) {
              setIsAdmin(true);
            } else {
              setIsAdmin(false);
            }
          } else {
            auth.signInAnonymously().catch(console.error);
            setIsAdmin(false);
          }
          setLoadingAuth(false);
        });
        return () => unsubscribe();
      }, []);

      const handleAdminLogin = async () => {
        if (!adminEmailInput || !adminPassword) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
        try {
          await auth.signInWithEmailAndPassword(adminEmailInput, adminPassword);
          setShowAdminLogin(false);
          setAdminPassword(''); 
          alert("ç®¡ç†å“¡ç™»å…¥æˆåŠŸï¼");
        } catch (error) {
          console.error(error);
          alert("ç™»å…¥å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
        }
      };

      const handleAdminLogout = async () => {
        await auth.signOut();
        alert("å·²ç™»å‡ºç®¡ç†æ¨¡å¼");
      };

      return (
        <div className="min-h-screen bg-[#fdfbf7] font-sans selection:bg-pink-100 pb-20 relative z-0">
          <nav className="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-sm border-b-2 border-dashed border-stone-200">
            <div className="max-w-md mx-auto px-4 h-14 flex items-center justify-between">
              <div className="flex items-center gap-2" onClick={() => setActiveTab('price')}>
                <DoodleEye className="w-8 h-6 text-stone-600" /><span className="font-bold text-lg tracking-wider text-stone-600">Bianca_eye</span>
              </div>
              <button onClick={() => setIsLookupOpen(true)} className="p-2 text-stone-500 hover:bg-stone-100 rounded-full transition">
                 <Icons.Search size={20} />
              </button>
            </div>
            
            <div className="max-w-md mx-auto px-2 flex justify-between items-center text-sm font-bold text-stone-400 overflow-x-auto no-scrollbar">
                {[
                  {id: 'price', label: 'åƒ¹ç›®è¡¨'},
                  {id: 'qa', label: 'Q&A'},
                  {id: 'notice', label: 'é ç´„é ˆçŸ¥'},
                  {id: 'booking', label: 'é ç´„æ™‚æ®µ'}
                ].map(tab => (
                    <button 
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        className={`flex-1 py-3 border-b-2 transition-all duration-300 whitespace-nowrap px-2 ${activeTab === tab.id ? 'border-[#dcb5bc] text-[#b07d88]' : 'border-transparent hover:text-stone-600'}`}
                    >
                        {tab.label}
                    </button>
                ))}
            </div>
          </nav>

          <header className="pt-32 pb-6 px-4 text-center max-w-md mx-auto">
            <div className="relative inline-block"><h1 className="text-2xl font-bold text-stone-600 tracking-widest">Bianca_eye.studio</h1><SquiggleLine className="w-24 h-3 text-[#dcb5bc] mx-auto" /></div>
          </header>

          <main className="max-w-md mx-auto px-4 pb-24 relative z-10">
            {activeTab === 'price' && <PriceView />}
            {activeTab === 'qa' && <QAView />}
            {activeTab === 'notice' && <NoticeView />}
            {activeTab === 'booking' && (
                <div className="tab-content">
                    <div className="flex items-center gap-2 mb-6 justify-center"><h2 className="text-xl font-bold text-stone-600">Booking</h2></div>
                    <HandDrawnBorder className="mb-8">
                        <h3 className="text-[#b07d88] font-bold text-center mb-4 flex justify-center items-center gap-2"><Icons.Calendar size={20} /> æŸ¥çœ‹å¯é ç´„æ™‚æ®µ</h3>
                        <p className="text-xs text-stone-500 text-center mb-4">é»æ“Šæ—¥æœŸæŸ¥çœ‹æ™‚æ®µï¼Œé»æ“Šã€Œé ç´„ã€å¯ç›´æ¥è¤‡è£½è¨Šæ¯</p>
                        <CalendarView isAdmin={isAdmin} user={auth.currentUser} />
                    </HandDrawnBorder>
                </div>
            )}
          </main>

          <ReservationLookupModal isOpen={isLookupOpen} onClose={() => setIsLookupOpen(false)} />

          <footer className="bg-stone-100 py-8 text-center text-stone-400 text-sm relative z-10">
            <DoodleEye className="w-6 h-4 mx-auto mb-2 opacity-50" />
            <p>&copy; 2024 Bianca_eye.studio</p>
            <p className="text-xs mt-1">Design for Beauty</p>
            
            <div className="mt-8 pt-4 border-t border-stone-200 w-3/4 mx-auto">
              {!isAdmin ? (
                <button onClick={() => setShowAdminLogin(!showAdminLogin)} className="text-[10px] text-stone-300 hover:text-stone-500 transition">
                  Manager Login
                </button>
              ) : (
                <div className="flex flex-col gap-2 items-center">
                   <span className="text-xs text-[#b07d88] font-bold">ç›®å‰ç‚ºç®¡ç†å“¡æ¨¡å¼</span>
                   <button onClick={handleAdminLogout} className="text-[10px] underline text-stone-400">ç™»å‡º (Exit)</button>
                </div>
              )}

              {showAdminLogin && !isAdmin && (
                <div className="mt-4 bg-white p-4 rounded-xl border border-stone-200 shadow-sm max-w-[200px] mx-auto flex flex-col gap-2">
                  <input 
                    type="email" 
                    placeholder="Email" 
                    className="text-xs p-2 border rounded w-full outline-none focus:border-[#dcb5bc]" 
                    value={adminEmailInput} 
                    onChange={(e) => setAdminEmailInput(e.target.value)} 
                  />
                  <input 
                    type="password" 
                    placeholder="Password" 
                    className="text-xs p-2 border rounded w-full outline-none focus:border-[#dcb5bc]" 
                    value={adminPassword} 
                    onChange={(e) => setAdminPassword(e.target.value)} 
                  />
                  <button onClick={handleAdminLogin} className="w-full py-2 bg-[#dcb5bc] text-white rounded-lg text-xs font-bold hover:opacity-90">
                    ç™»å…¥
                  </button>
                </div>
              )}
            </div>
            
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>